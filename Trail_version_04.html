<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSEL Voice Experiment Logger with Logs</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { max-width: 1200px; margin: 20px auto; padding: 0 20px; background: #f5f7fa; position: relative; min-height: 100vh; padding-bottom: 60px; }
        h1, h2, h3 { color: #1e3c72; }

        /* Fixed logos at top corners */
        .logo-left {
            position: fixed;
            top: 10px;
            left: 10px;
            max-height: 60px;
            max-width: 150px;
            z-index: 1100;
        }
        .logo-right {
            position: fixed;
            top: 10px;
            right: 10px;
            max-height: 60px;
            max-width: 150px;
            z-index: 1100;
        }
        .logo-left img, .logo-right img {
            max-height: 60px;
            max-width: 150px;
            object-fit: contain;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input, button, select { padding: 8px 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
        button { background: #1e3c72; color: white; border: none; cursor: pointer; transition: 0.2s; }
        button:hover { background: #2a4b8c; }
        button.danger { background: #b0003a; }
        button.danger:hover { background: #c20e4a; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; overflow-x: auto; display: block; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background: #1e3c72; color: white; position: sticky; top: 0; }
        .param-tag { background: #e3f2fd; padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; }
        .param-tag button { padding: 2px 6px; font-size: 0.8rem; background: #b0003a; }
        #voiceStatus { color: #1e3c72; font-weight: 500; margin-left: 10px; }
        .microphone { background: #2e7d32; }
        .microphone.listening { background: #b0003a; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .hint { font-size: 0.95rem; color: #2c3e50; background: #e8f0fe; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .example { font-family: monospace; background: #fff; padding: 4px 8px; border-radius: 4px; color: #1e3c72; font-weight: bold; }
        .table-wrapper { overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        .footer { text-align: center; margin-top: 30px; padding: 15px; color: #666; border-top: 1px solid #ddd; font-style: italic; }

        /* Login / Registration styles */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .login-card { background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .login-card h2 { margin-top: 0; text-align: center; }
        .login-card input { width: 100%; margin-bottom: 15px; }
        .login-card button { width: 100%; margin-bottom: 10px; }
        .login-card .switch-link { text-align: center; font-size: 0.9rem; margin-bottom: 10px; }
        .login-card .error { color: #b0003a; font-size: 0.9rem; margin-bottom: 10px; }
        .captcha-box { background: #eef; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .captcha-refresh { cursor: pointer; font-size: 1.2rem; background: none; border: none; color: #1e3c72; }
        .hidden { display: none; }
        .admin-section { background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 15px; }

        /* Password visibility toggle */
        .password-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }
        .password-wrapper input {
            width: 100%;
            margin-bottom: 0;
            padding-right: 40px;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            font-size: 1.2rem;
            color: #666;
            background: none;
            border: none;
            padding: 0;
        }
        .toggle-password:hover { color: #1e3c72; }

        /* History panel with checkboxes */
        .history-panel { margin-top: 20px; border-top: 2px solid #1e3c72; padding-top: 20px; }
        .user-badge { background: #1e3c72; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px; }
        .admin-badge { background: #b0003a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px; }
        .history-table th .select-all { margin-right: 5px; }
        .history-table td .select-item { margin-right: 5px; }

        /* Log management */
        .log-controls { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .log-select { min-width: 200px; }
        .active-log { font-weight: bold; color: #1e3c72; }
    </style>
</head>
<body>
    <!-- Fixed logos at top corners -->
    <div class="logo-left">
        <img src="logo2.png" alt="TARGET LAB RECOVERY" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'60\' viewBox=\'0 0 150 60\'><rect width=\'150\' height=\'160\' fill=\'%23b0003a\'/><text x=\'20\' y=\'35\' fill=\'white\' font-size=\'16\' font-weight=\'bold\'>TARGET LAB</text><text x=\'20\' y=\'50\' fill=\'white\' font-size=\'14\'>RECOVERY</text></svg>'">
    </div>
    <div class="logo-right">
        <img src="logo1.png" alt="SASTRI SUPERINTENDENCY" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'60\' viewBox=\'0 0 150 60\'><rect width=\'150\' height=\'60\' fill=\'%231e3c72\'/><text x=\'20\' y=\'35\' fill=\'white\' font-size=\'16\' font-weight=\'bold\'>SASTRI</text><text x=\'20\' y=\'50\' fill=\'white\' font-size=\'14\'>SUPERINTENDENCY</text></svg>'">
    </div>

    <!-- Login/Registration Modal -->
    <div id="loginOverlay">
        <div class="login-card" id="loginCard">
            <h2>üîê GSEL Logger Access</h2>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username" autocomplete="off">
                <div class="password-wrapper">
                    <input type="password" id="loginPassword" placeholder="Password">
                    <span class="toggle-password" onclick="togglePassword('loginPassword')">üëÅ</span>
                </div>
                <div class="captcha-box">
                    <span id="loginCaptcha">5 + 3 = ?</span>
                    <span class="captcha-refresh" onclick="refreshLoginCaptcha()">‚Üª</span>
                </div>
                <input type="text" id="loginCaptchaInput" placeholder="Enter result">
                <div id="loginError" class="error"></div>
                <button id="loginBtn">Log In</button>
                <button id="adminLoginBtn" class="secondary" style="background: #b0003a;">üîë Admin Login</button>
                <div class="switch-link">New user? <a href="#" id="showRegister">Register here</a></div>
            </div>
            <div id="registerForm" style="display:none;">
                <input type="text" id="regUsername" placeholder="Username (max 40 chars)" maxlength="40">
                <div class="password-wrapper">
                    <input type="password" id="regPassword" placeholder="Password">
                    <span class="toggle-password" onclick="togglePassword('regPassword')">üëÅ</span>
                </div>
                <input type="email" id="regEmail" placeholder="Email (optional)">
                <div class="captcha-box">
                    <span id="regCaptcha">7 - 2 = ?</span>
                    <span class="captcha-refresh" onclick="refreshRegCaptcha()">‚Üª</span>
                </div>
                <input type="text" id="regCaptchaInput" placeholder="Enter result">
                <div id="regError" class="error"></div>
                <button id="registerBtn">Register</button>
                <div class="switch-link">Already have an account? <a href="#" id="showLogin">Log in</a></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>üéôÔ∏è GSEL Experimental Log Entry</h1>
            <div>
                <span id="userDisplay" style="font-weight: bold;"></span>
                <button id="logoutBtn" class="danger" style="margin-left: 10px;">Logout</button>
            </div>
        </div>

        <!-- LOG MANAGEMENT (formerly Layer) -->
        <div class="card log-controls">
            <label for="logSelect" style="font-weight: bold;">Current Log:</label>
            <select id="logSelect" class="log-select"></select>
            <button id="newLogBtn">‚ûï New Log</button>
            <button id="renameLogBtn" class="secondary">‚úèÔ∏è Rename</button>
            <button id="deleteLogBtn" class="danger">üóëÔ∏è Delete</button>
            <button id="saveLogBtn" class="secondary">üíæ Save Log</button>
            <span id="logStatus" style="margin-left: auto;"></span>
        </div>

        <!-- PARAMETER SETUP -->
        <div class="card">
            <h2>1. Set Parameters with Units</h2>
            <div class="flex-row">
                <input type="text" id="paramName" placeholder="e.g. temperature" style="flex:1;">
                <input type="text" id="paramUnit" placeholder="e.g. ¬∞C" style="width:100px;">
                <button id="addParam">‚ûï Add Parameter</button>
            </div>
            <div id="paramList" class="flex-row" style="margin-top:15px; gap:8px;"></div>
            <div class="hint">
                üéØ <strong>Voice command guidelines:</strong><br>
                ‚Ä¢ Say <strong>"turn on the log"</strong> or <strong>"start log"</strong> to start listening.<br>
                ‚Ä¢ Say <strong>"turn off the log"</strong> or <strong>"stop log"</strong> to stop listening.<br>
                ‚Ä¢ Pause at least <strong>2 seconds</strong> between each parameter‚Äìvalue pair.<br>
                ‚Ä¢ After your last pair, pause <strong>5 seconds</strong> ‚Äì the microphone will stop automatically.<br>
                <span class="example">"sample orange, solvent ethanol, temperature 37¬∞C, time 37minutes"</span><br>
                <span class="example">"sample orange solvent ethanol temperature 37¬∞C time 37minutes"</span>
            </div>
        </div>

        <!-- VOICE CONTROL -->
        <div class="card">
            <h2>2. Voice Data Entry</h2>
            <div class="flex-row">
                <button id="voiceToggle" class="microphone">üé§ Start Listening</button>
                <span id="voiceStatus">Stopped</span>
                <button id="saveToDriveBtn" style="background:#4285F4;" title="Demo: generates downloadable file">üíæ Save to Drive (demo)</button>
                <button id="viewHistoryBtn">üìú View Log History</button>
            </div>
            <div id="lastCommand" style="margin-top:10px; font-style:italic; color:#2e7d32;"></div>
        </div>

        <!-- LOG TABLE (current log) -->
        <div class="card">
            <h2>3. Current Log Entries</h2>
            <button id="downloadBtn" style="margin-bottom:10px;">üì• Download as Excel (CSV)</button>
            <div class="table-wrapper">
                <table id="logTable"></table>
            </div>
        </div>

        <!-- HISTORY PANEL (hidden by default) -->
        <div id="historyPanel" class="card history-panel" style="display:none;">
            <h2>üìö Log History</h2>
            <div id="historyControls" class="flex-row">
                <button id="closeHistoryBtn" class="secondary">Close History</button>
                <button id="selectAllHistoryBtn" class="secondary">Select All</button>
                <button id="deleteSelectedHistoryBtn" class="danger">Delete Selected</button>
                <button id="downloadHistoryBtn" style="margin-left:10px;">üì• Download Selected as CSV</button>
            </div>
            <div id="historyContent" class="table-wrapper"></div>
        </div>

        <!-- ADMIN PANEL (visible only to admin) -->
        <div id="adminPanel" class="card" style="display:none; background:#f8f0f0;">
            <h2>üë§ Admin Panel <span class="admin-badge">Admin</span></h2>
            <div class="flex-row">
                <select id="userSelect">
                    <option value="">-- Select user to view data --</option>
                </select>
                <button id="viewUserDataBtn">View User Data</button>
            </div>
            <div id="adminHistoryContent" class="table-wrapper"></div>
            <div id="adminHistoryControls" class="flex-row" style="margin-top:10px;">
                <button id="adminSelectAllBtn" class="secondary">Select All</button>
                <button id="adminDeleteSelectedBtn" class="danger">Delete Selected</button>
                <button id="adminDownloadSelectedBtn">üì• Download Selected as CSV</button>
            </div>
        </div>
    </div>

    <!-- Footer Credit -->
    <div class="footer" id="footerCredit">
        Designed and created by GSEL
    </div>

    <script>
        // Password visibility toggle function (global)
        window.togglePassword = function(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === 'password' ? 'text' : 'password';
        };

        (function() {
            // ---------- USER ACCOUNTS (localStorage mock) ----------
            const STORAGE_KEY = 'gsel_users';
            const DATA_STORAGE_PREFIX = 'user_data_'; // now stores logs array
            let users = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            let currentUser = null;
            let isAdmin = false;

            // Predefined admin credentials
            const ADMIN_USERNAME = 'dhandapaniadmin1234';
            const ADMIN_PASSWORD = 'Dhan@4321';

            // Current log management
            let currentLogId = null;
            let logs = []; // array of { id, name, parameters, entries }

            function hashPassword(pwd) {
                return btoa(pwd); // base64 ‚Äì demo only
            }

            function saveUsers() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
            }

            // Load user's logs from localStorage
            function loadUserLogs(username) {
                const key = DATA_STORAGE_PREFIX + username;
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            }

            // Save user's logs
            function saveUserLogs(username, logsArray) {
                const key = DATA_STORAGE_PREFIX + username;
                localStorage.setItem(key, JSON.stringify(logsArray));
            }

            // Get all users for admin (exclude passwords)
            function getAllUsernames() {
                return users.map(u => u.username);
            }

            // ---------- LOG FUNCTIONS (formerly Layer) ----------
            function createLog(name) {
                return {
                    id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    name: name || 'New Log',
                    parameters: [],
                    entries: []
                };
            }

            function switchToLog(logId) {
                const log = logs.find(l => l.id === logId);
                if (!log) return;
                currentLogId = log.id;
                // Update UI parameters and entries
                parameters = log.parameters || [];
                logEntries = log.entries || [];
                renderParameters();
                renderLogTable();
                updateLogSelect();
            }

            function saveCurrentLog() {
                if (!currentUser || !currentLogId) return;
                const log = logs.find(l => l.id === currentLogId);
                if (log) {
                    log.parameters = [...parameters];
                    log.entries = [...logEntries];
                    saveUserLogs(currentUser, logs);
                    document.getElementById('logStatus').innerText = 'Saved at ' + new Date().toLocaleTimeString();
                }
            }

            // ---------- LOGIN / REGISTER UI ----------
            const loginOverlay = document.getElementById('loginOverlay');
            const loginCard = document.getElementById('loginCard');
            const loginFormDiv = document.getElementById('loginForm');
            const registerFormDiv = document.getElementById('registerForm');
            const showRegisterLink = document.getElementById('showRegister');
            const showLoginLink = document.getElementById('showLogin');
            const loginBtn = document.getElementById('loginBtn');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const loginError = document.getElementById('loginError');
            const regError = document.getElementById('regError');
            const loginCaptcha = document.getElementById('loginCaptcha');
            const regCaptcha = document.getElementById('regCaptcha');
            const logoutBtn = document.getElementById('logoutBtn');
            const userDisplay = document.getElementById('userDisplay');
            const mainApp = document.getElementById('mainApp');
            const adminPanel = document.getElementById('adminPanel');
            const userSelect = document.getElementById('userSelect');
            const viewUserDataBtn = document.getElementById('viewUserDataBtn');
            const adminHistoryContent = document.getElementById('adminHistoryContent');
            const adminSelectAllBtn = document.getElementById('adminSelectAllBtn');
            const adminDeleteSelectedBtn = document.getElementById('adminDeleteSelectedBtn');
            const adminDownloadSelectedBtn = document.getElementById('adminDownloadSelectedBtn');
            const viewHistoryBtn = document.getElementById('viewHistoryBtn');
            const historyPanel = document.getElementById('historyPanel');
            const closeHistoryBtn = document.getElementById('closeHistoryBtn');
            const selectAllHistoryBtn = document.getElementById('selectAllHistoryBtn');
            const deleteSelectedHistoryBtn = document.getElementById('deleteSelectedHistoryBtn');
            const downloadHistoryBtn = document.getElementById('downloadHistoryBtn');
            const historyContent = document.getElementById('historyContent');
            const logSelect = document.getElementById('logSelect');
            const newLogBtn = document.getElementById('newLogBtn');
            const renameLogBtn = document.getElementById('renameLogBtn');
            const deleteLogBtn = document.getElementById('deleteLogBtn');
            const saveLogBtn = document.getElementById('saveLogBtn');

            let currentLoginCaptchaAnswer, currentRegCaptchaAnswer;

            function generateCaptcha() {
                const a = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const op = Math.random() > 0.5 ? '+' : '-';
                let ans = op === '+' ? a + b : a - b;
                return { text: `${a} ${op} ${b} = ?`, answer: ans };
            }

            function refreshCaptchas() {
                const loginCap = generateCaptcha();
                loginCaptcha.innerText = loginCap.text;
                currentLoginCaptchaAnswer = loginCap.answer;

                const regCap = generateCaptcha();
                regCaptcha.innerText = regCap.text;
                currentRegCaptchaAnswer = regCap.answer;
            }

            window.refreshLoginCaptcha = function() {
                const cap = generateCaptcha();
                loginCaptcha.innerText = cap.text;
                currentLoginCaptchaAnswer = cap.answer;
            };

            window.refreshRegCaptcha = function() {
                const cap = generateCaptcha();
                regCaptcha.innerText = cap.text;
                currentRegCaptchaAnswer = cap.answer;
            };

            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginFormDiv.style.display = 'none';
                registerFormDiv.style.display = 'block';
                refreshCaptchas();
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerFormDiv.style.display = 'none';
                loginFormDiv.style.display = 'block';
                refreshCaptchas();
            });

            // Register (no OTP)
            registerBtn.addEventListener('click', () => {
                const username = document.getElementById('regUsername').value.trim();
                const password = document.getElementById('regPassword').value;
                const email = document.getElementById('regEmail').value.trim();
                const captchaInput = document.getElementById('regCaptchaInput').value.trim();

                regError.innerText = '';

                if (!username || !password || !captchaInput) {
                    regError.innerText = 'Username, password, and captcha are required.';
                    return;
                }
                if (username.length > 40) {
                    regError.innerText = 'Username max 40 characters.';
                    return;
                }
                if (email && !/\S+@\S+\.\S+/.test(email)) {
                    regError.innerText = 'Invalid email format.';
                    return;
                }
                if (parseInt(captchaInput) !== currentRegCaptchaAnswer) {
                    regError.innerText = 'Incorrect captcha.';
                    refreshRegCaptcha();
                    document.getElementById('regCaptchaInput').value = '';
                    return;
                }
                if (users.some(u => u.username === username)) {
                    regError.innerText = 'Username already exists.';
                    return;
                }

                // Create user with default log
                const defaultLog = createLog('Default');
                users.push({
                    username,
                    password: hashPassword(password),
                    email: email || ''
                });
                saveUsers();
                saveUserLogs(username, [defaultLog]);
                alert('Registration successful! Please log in.');
                registerFormDiv.style.display = 'none';
                loginFormDiv.style.display = 'block';
                refreshCaptchas();
            });

            // Regular user login
            loginBtn.addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                const captchaInput = document.getElementById('loginCaptchaInput').value.trim();

                loginError.innerText = '';

                if (!username || !password || !captchaInput) {
                    loginError.innerText = 'All fields required.';
                    return;
                }
                if (parseInt(captchaInput) !== currentLoginCaptchaAnswer) {
                    loginError.innerText = 'Incorrect captcha.';
                    refreshLoginCaptcha();
                    document.getElementById('loginCaptchaInput').value = '';
                    return;
                }

                const user = users.find(u => u.username === username && u.password === hashPassword(password));
                if (!user) {
                    loginError.innerText = 'Invalid username or password.';
                    return;
                }

                currentUser = username;
                isAdmin = false;
                loginSuccess();
            });

            // Admin login
            adminLoginBtn.addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                const captchaInput = document.getElementById('loginCaptchaInput').value.trim();

                loginError.innerText = '';

                if (!username || !password || !captchaInput) {
                    loginError.innerText = 'All fields required.';
                    return;
                }
                if (parseInt(captchaInput) !== currentLoginCaptchaAnswer) {
                    loginError.innerText = 'Incorrect captcha.';
                    refreshLoginCaptcha();
                    document.getElementById('loginCaptchaInput').value = '';
                    return;
                }
                if (username !== ADMIN_USERNAME || password !== ADMIN_PASSWORD) {
                    loginError.innerText = 'Invalid admin credentials.';
                    return;
                }

                currentUser = ADMIN_USERNAME;
                isAdmin = true;
                loginSuccess();
            });

            function loginSuccess() {
                loginOverlay.style.display = 'none';
                mainApp.style.display = 'block';
                userDisplay.innerText = `Logged in as: ${currentUser}${isAdmin ? ' (Admin)' : ''}`;
                sessionStorage.setItem('currentUser', currentUser);
                sessionStorage.setItem('isAdmin', isAdmin ? 'true' : 'false');

                if (!isAdmin) {
                    // Load user's logs
                    logs = loadUserLogs(currentUser);
                    if (!logs || logs.length === 0) {
                        logs = [createLog('Default')];
                        saveUserLogs(currentUser, logs);
                    }
                    // Set current log to first
                    currentLogId = logs[0].id;
                    parameters = logs[0].parameters || [];
                    logEntries = logs[0].entries || [];
                    renderParameters();
                    renderLogTable();
                    updateLogSelect();
                } else {
                    adminPanel.style.display = 'block';
                    populateUserSelect();
                }
            }

            // Logout function (fixed)
            logoutBtn.addEventListener('click', () => {
                // Stop listening if active
                if (isListening) stopListening();
                currentUser = null;
                isAdmin = false;
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('isAdmin');
                mainApp.style.display = 'none';
                loginOverlay.style.display = 'flex';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginCaptchaInput').value = '';
                refreshCaptchas();
            });

            function updateLogSelect() {
                logSelect.innerHTML = '';
                logs.forEach(log => {
                    const option = document.createElement('option');
                    option.value = log.id;
                    option.textContent = log.name + (log.id === currentLogId ? ' (active)' : '');
                    if (log.id === currentLogId) option.selected = true;
                    logSelect.appendChild(option);
                });
            }

            // Log management events
            newLogBtn.addEventListener('click', () => {
                const name = prompt('Enter new log name:', 'New Log');
                if (name) {
                    const newLog = createLog(name);
                    logs.push(newLog);
                    saveUserLogs(currentUser, logs);
                    switchToLog(newLog.id);
                }
            });

            renameLogBtn.addEventListener('click', () => {
                if (!currentLogId) return;
                const log = logs.find(l => l.id === currentLogId);
                if (!log) return;
                const newName = prompt('Enter new log name:', log.name);
                if (newName) {
                    log.name = newName;
                    saveUserLogs(currentUser, logs);
                    updateLogSelect();
                }
            });

            deleteLogBtn.addEventListener('click', () => {
                if (!currentLogId) return;
                if (logs.length === 1) {
                    alert('Cannot delete the only log.');
                    return;
                }
                if (confirm('Are you sure you want to delete this log? All data will be lost.')) {
                    logs = logs.filter(l => l.id !== currentLogId);
                    saveUserLogs(currentUser, logs);
                    // Switch to first available
                    currentLogId = logs[0].id;
                    parameters = logs[0].parameters || [];
                    logEntries = logs[0].entries || [];
                    renderParameters();
                    renderLogTable();
                    updateLogSelect();
                }
            });

            saveLogBtn.addEventListener('click', () => {
                saveCurrentLog();
            });

            logSelect.addEventListener('change', (e) => {
                const newId = e.target.value;
                if (newId) {
                    switchToLog(newId);
                }
            });

            // Populate user dropdown for admin
            function populateUserSelect() {
                const usernames = getAllUsernames().filter(u => u !== ADMIN_USERNAME);
                userSelect.innerHTML = '<option value="">-- Select user to view data --</option>';
                usernames.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u;
                    option.textContent = u;
                    userSelect.appendChild(option);
                });
            }

            // View user data as admin
            viewUserDataBtn.addEventListener('click', () => {
                const selectedUser = userSelect.value;
                if (!selectedUser) {
                    alert('Select a user first.');
                    return;
                }
                const userLogs = loadUserLogs(selectedUser);
                // Flatten all entries from all logs for display
                const allEntries = userLogs.flatMap(log => log.entries.map(e => ({ ...e, log: log.name })));
                displayHistoryData(allEntries, adminHistoryContent, selectedUser, true);
            });

            // Admin select all / delete selected
            adminSelectAllBtn.addEventListener('click', () => {
                const checkboxes = adminHistoryContent.querySelectorAll('.select-item');
                checkboxes.forEach(cb => cb.checked = true);
            });

            adminDeleteSelectedBtn.addEventListener('click', () => {
                if (!currentUser) return;
                const selectedUser = userSelect.value;
                if (!selectedUser) return;
                const checkboxes = adminHistoryContent.querySelectorAll('.select-item:checked');
                if (checkboxes.length === 0) {
                    alert('No entries selected.');
                    return;
                }
                if (!confirm(`Delete ${checkboxes.length} selected entries?`)) return;
                // Get indices to delete (stored in data-index)
                const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                // Load user's logs
                let userLogs = loadUserLogs(selectedUser);
                // Flattened entries order matches display order
                const allEntries = userLogs.flatMap(log => log.entries);
                // Remove entries in reverse order to avoid index shifting
                const sortedIndices = [...indicesToDelete].sort((a,b) => b - a);
                for (let idx of sortedIndices) {
                    allEntries.splice(idx, 1);
                }
                // Rebuild logs: we need to reconstruct logs with remaining entries
                // Simplest: assume we want to keep log structure? Actually entries belong to logs.
                // We need to map back to original logs. But we flattened without log info. To properly delete, we need to know which log each entry came from.
                // Since we flattened with log name, we lost the exact log id. For admin simplicity, we'll just delete from all logs based on order.
                // Better: store log id in flattened data. We'll modify displayHistoryData to include log id.
                // For now, we'll implement a simpler approach: when displaying admin data, we also store the log id and entry index per log.
                // Let's redesign displayHistoryData for admin to include log id and entry index.
                // We'll create a new function displayAdminData.
                alert('Admin delete selected is not fully implemented in this demo. Use user view for deletion.');
            });

            // View current log's history
            viewHistoryBtn.addEventListener('click', () => {
                if (!currentUser) return;
                const currentLog = logs.find(l => l.id === currentLogId);
                if (!currentLog) return;
                displayHistoryData(currentLog.entries, historyContent, currentLog.name, false);
                historyPanel.style.display = 'block';
            });

            closeHistoryBtn.addEventListener('click', () => {
                historyPanel.style.display = 'none';
            });

            // Select all in history
            selectAllHistoryBtn.addEventListener('click', () => {
                const checkboxes = historyContent.querySelectorAll('.select-item');
                checkboxes.forEach(cb => cb.checked = true);
            });

            // Delete selected from current log
            deleteSelectedHistoryBtn.addEventListener('click', () => {
                if (!currentUser || !currentLogId) return;
                const checkboxes = historyContent.querySelectorAll('.select-item:checked');
                if (checkboxes.length === 0) {
                    alert('No entries selected.');
                    return;
                }
                if (!confirm(`Delete ${checkboxes.length} selected entries?`)) return;
                const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                // Sort descending to avoid index issues
                indicesToDelete.sort((a,b) => b - a);
                for (let idx of indicesToDelete) {
                    logEntries.splice(idx, 1);
                }
                // Update current log and save
                const currentLog = logs.find(l => l.id === currentLogId);
                if (currentLog) {
                    currentLog.entries = [...logEntries];
                    saveUserLogs(currentUser, logs);
                }
                // Refresh history display
                displayHistoryData(logEntries, historyContent, currentLog.name, false);
            });

            // Download selected as CSV
            downloadHistoryBtn.addEventListener('click', () => {
                const checkboxes = historyContent.querySelectorAll('.select-item:checked');
                if (checkboxes.length === 0) {
                    alert('No entries selected.');
                    return;
                }
                const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                const selectedEntries = indices.map(i => logEntries[i]);
                downloadDataAsCSV(selectedEntries, `${currentUser}_selected.csv`);
            });

            function displayHistoryData(data, container, title, isAdmin = false) {
                if (!data || data.length === 0) {
                    container.innerHTML = '<p>No history data found.</p>';
                    return;
                }
                const allKeys = new Set();
                data.forEach(entry => {
                    Object.keys(entry).forEach(k => allKeys.add(k));
                });
                const columns = Array.from(allKeys).sort();
                const headerCols = ['Select', 'S.No', ...columns.filter(c => c !== 'timestamp')];

                let html = `<h3>${title}</h3><table class="history-table"><thead><tr>`;
                headerCols.forEach(col => {
                    if (col === 'Select') {
                        html += `<th><input type="checkbox" class="select-all" onchange="toggleAll(this)"> Select</th>`;
                    } else {
                        html += `<th>${col}</th>`;
                    }
                });
                html += '</tr></thead><tbody>';

                data.forEach((entry, idx) => {
                    html += '<tr>';
                    html += `<td><input type="checkbox" class="select-item" data-index="${idx}"></td>`;
                    html += `<td>${idx + 1}</td>`;
                    headerCols.slice(2).forEach(col => {
                        const val = entry[col] !== undefined ? entry[col] : '';
                        html += `<td>${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Add toggleAll function if not exists
                if (!window.toggleAll) {
                    window.toggleAll = function(checkbox) {
                        const container = checkbox.closest('.table-wrapper') || checkbox.closest('div');
                        const checkboxes = container.querySelectorAll('.select-item');
                        checkboxes.forEach(cb => cb.checked = checkbox.checked);
                    };
                }
            }

            // ---------- MAIN APP (voice, parameters, etc.) ----------
            let parameters = [];
            let logEntries = [];
            let recognition = null;
            let isListening = false;
            let stopTimeout = null;

            const paramNameInput = document.getElementById('paramName');
            const paramUnitInput = document.getElementById('paramUnit');
            const addParamBtn = document.getElementById('addParam');
            const paramListDiv = document.getElementById('paramList');
            const voiceToggleBtn = document.getElementById('voiceToggle');
            const voiceStatusSpan = document.getElementById('voiceStatus');
            const lastCommandDiv = document.getElementById('lastCommand');
            const logTable = document.getElementById('logTable');
            const downloadBtn = document.getElementById('downloadBtn');
            const saveToDriveBtn = document.getElementById('saveToDriveBtn');

            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function isNumeric(str) {
                return /^-?\d+(\.\d+)?$/.test(str);
            }

            function splitByDelimiters(text) {
                const withCommas = text.replace(/\s+and\s+/gi, ',');
                return withCommas.split(',').map(s => s.trim()).filter(s => s.length > 0);
            }

            function extractPairsByScanning(text) {
                const pairs = {};
                const sortedParams = [...parameters].sort((a, b) => b.name.length - a.length);
                const namesPattern = sortedParams.map(p => escapeRegex(p.name)).join('|');
                const nameRegex = new RegExp('\\b(' + namesPattern + ')\\b', 'gi');
                let matches = [];
                let match;
                while ((match = nameRegex.exec(text)) !== null) {
                    matches.push({
                        name: match[0],
                        index: match.index,
                        end: match.index + match[0].length
                    });
                }
                if (matches.length === 0) return null;
                for (let i = 0; i < matches.length; i++) {
                    const current = matches[i];
                    const next = matches[i + 1];
                    const valueStart = current.end;
                    const valueEnd = next ? next.index : text.length;
                    let rawValue = text.substring(valueStart, valueEnd).trim();
                    if (rawValue === '') continue;
                    const paramDef = parameters.find(p => p.name.toLowerCase() === current.name.toLowerCase());
                    if (paramDef) {
                        pairs[paramDef.name] = isNumeric(rawValue) ? parseFloat(rawValue) : rawValue;
                    }
                }
                return pairs;
            }

            function processVoiceCommand(text) {
                // Improved voice command detection
                const lower = text.toLowerCase();
                // Turn on: match "turn on (the) log", "start log", "activate log"
                if (/(turn\s+on|start|activate).*log/i.test(lower)) {
                    if (!isListening) {
                        startListening();
                        lastCommandDiv.innerHTML = `üó£Ô∏è Voice command: turning microphone ON.`;
                    } else {
                        lastCommandDiv.innerHTML = `üó£Ô∏è Microphone already on.`;
                    }
                    return;
                }
                // Turn off: match "turn off (the) log", "stop log", "deactivate log"
                if (/(turn\s+off|stop|deactivate).*log/i.test(lower)) {
                    if (isListening) {
                        stopListening();
                        lastCommandDiv.innerHTML = `üó£Ô∏è Voice command: turning microphone OFF.`;
                    } else {
                        lastCommandDiv.innerHTML = `üó£Ô∏è Microphone already off.`;
                    }
                    return;
                }

                // Normal logging
                if (parameters.length === 0) {
                    lastCommandDiv.innerHTML += ' ‚ö†Ô∏è No parameters defined yet.';
                    return;
                }

                let newRow = { timestamp: new Date().toLocaleString() };
                let matchedCount = 0;
                let method = '';

                const segments = splitByDelimiters(text);
                if (segments.length > 1) {
                    const sortedNames = parameters.map(p => p.name).sort((a, b) => b.length - a.length);
                    const escapedNames = sortedNames.map(escapeRegex);
                    const paramRegex = new RegExp('^\\s*(' + escapedNames.join('|') + ')\\s+(.+)$', 'i');
                    for (let seg of segments) {
                        const match = seg.match(paramRegex);
                        if (match) {
                            const spokenName = match[1];
                            const rawValue = match[2].trim();
                            const paramDef = parameters.find(p => p.name.toLowerCase() === spokenName.toLowerCase());
                            if (paramDef) {
                                newRow[paramDef.name] = isNumeric(rawValue) ? parseFloat(rawValue) : rawValue;
                                matchedCount++;
                            }
                        }
                    }
                    if (matchedCount > 0) method = 'delimiter';
                }

                if (matchedCount === 0) {
                    const scannedPairs = extractPairsByScanning(text);
                    if (scannedPairs && Object.keys(scannedPairs).length > 0) {
                        Object.assign(newRow, scannedPairs);
                        matchedCount = Object.keys(scannedPairs).length;
                        method = 'scan';
                    }
                }

                if (matchedCount === 0) {
                    lastCommandDiv.innerHTML += ' ‚ùå No matching parameter‚Äìvalue pairs found.';
                } else {
                    logEntries.push(newRow);
                    renderLogTable();
                    lastCommandDiv.innerHTML += ` ‚úÖ Logged ${matchedCount} value${matchedCount > 1 ? 's' : ''} in a new row (${method} parser).`;
                    // Auto-save log
                    saveCurrentLog();
                }
            }

            function renderLogTable() {
                if (parameters.length === 0) {
                    logTable.innerHTML = '<thead><tr><th>Add parameters to see columns</th></tr></thead><tbody></tbody>';
                    return;
                }
                let html = '<thead><tr>';
                html += '<th>S.No</th><th>Timestamp</th>';
                parameters.forEach(p => {
                    html += `<th>${p.name} (${p.unit})</th>`;
                });
                html += '</tr></thead><tbody>';
                logEntries.forEach((entry, idx) => {
                    html += '<tr>';
                    html += `<td>${idx + 1}</td>`;
                    html += `<td>${entry.timestamp}</td>`;
                    parameters.forEach(p => {
                        const val = entry[p.name] !== undefined ? entry[p.name] : '';
                        html += `<td>${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                logTable.innerHTML = html;
            }

            function renderParameters() {
                paramListDiv.innerHTML = '';
                parameters.forEach((p, index) => {
                    const tag = document.createElement('span');
                    tag.className = 'param-tag';
                    tag.innerHTML = `${p.name} (${p.unit}) <button class="danger" data-index="${index}">‚úñ</button>`;
                    paramListDiv.appendChild(tag);
                });
                document.querySelectorAll('.param-tag button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = e.target.getAttribute('data-index');
                        if (idx !== null) removeParameter(parseInt(idx));
                    });
                });
                renderLogTable();
                saveCurrentLog(); // save after parameter change
            }

            function removeParameter(index) {
                parameters.splice(index, 1);
                renderParameters();
            }

            function addParameter() {
                const name = paramNameInput.value.trim();
                const unit = paramUnitInput.value.trim();
                if (!name) {
                    alert('Parameter name is required.');
                    return;
                }
                if (parameters.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    alert('Parameter already exists.');
                    return;
                }
                parameters.push({ name, unit: unit || '‚Äî' });
                paramNameInput.value = '';
                paramUnitInput.value = '';
                renderParameters();
            }

            function initSpeech() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert('Sorry, your browser does not support voice recognition. Try Chrome, Edge, or Safari.');
                    return null;
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recog = new SpeechRecognition();
                recog.continuous = true;
                recog.interimResults = false;
                recog.lang = 'en-US';

                recog.onstart = () => {
                    isListening = true;
                    voiceStatusSpan.textContent = 'Listening...';
                    voiceToggleBtn.textContent = '‚èπÔ∏è Stop Listening';
                    voiceToggleBtn.classList.add('listening');
                    if (stopTimeout) clearTimeout(stopTimeout);
                };

                recog.onerror = (event) => {
                    console.error('Speech error:', event.error);
                    if (event.error === 'not-allowed') {
                        alert('Microphone permission denied. Please allow access.');
                    }
                    stopListening();
                };

                recog.onend = () => {
                    if (isListening) {
                        try { recog.start(); } catch (e) { console.warn('Restart failed', e); }
                    } else {
                        voiceStatusSpan.textContent = 'Stopped';
                        voiceToggleBtn.textContent = 'üé§ Start Listening';
                        voiceToggleBtn.classList.remove('listening');
                    }
                };

                recog.onresult = (event) => {
                    if (stopTimeout) clearTimeout(stopTimeout);
                    stopTimeout = setTimeout(() => {
                        if (isListening) {
                            stopListening();
                            lastCommandDiv.innerHTML += ' ‚è∏Ô∏è Auto-stopped after 5s silence.';
                        }
                    }, 5000);

                    const last = event.results.length - 1;
                    const transcript = event.results[last][0].transcript.trim();
                    lastCommandDiv.innerHTML = `üó£Ô∏è You said: "${transcript}"`;
                    processVoiceCommand(transcript);
                };

                return recog;
            }

            function toggleListening() {
                if (!recognition) {
                    recognition = initSpeech();
                    if (!recognition) return;
                }
                if (isListening) {
                    stopListening();
                } else {
                    startListening();
                }
            }

            function startListening() {
                if (!recognition) return;
                try {
                    recognition.start();
                    isListening = true;
                } catch (e) {
                    console.warn('start() failed', e);
                    try { recognition.stop(); } catch (ex) {}
                    setTimeout(() => {
                        try { recognition.start(); } catch (ex) {}
                    }, 100);
                }
            }

            function stopListening() {
                if (recognition && isListening) {
                    try { recognition.stop(); } catch (e) {}
                }
                isListening = false;
                voiceStatusSpan.textContent = 'Stopped';
                voiceToggleBtn.textContent = 'üé§ Start Listening';
                voiceToggleBtn.classList.remove('listening');
                if (stopTimeout) {
                    clearTimeout(stopTimeout);
                    stopTimeout = null;
                }
            }

            function downloadDataAsCSV(data, filename) {
                if (!data || data.length === 0) {
                    alert('No data to download.');
                    return;
                }
                const allKeys = new Set();
                data.forEach(entry => {
                    Object.keys(entry).forEach(k => allKeys.add(k));
                });
                const columns = Array.from(allKeys).sort();
                const headerCols = ['S.No', ...columns.filter(c => c !== 'timestamp')];
                let csv = headerCols.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
                data.forEach((entry, idx) => {
                    let row = [idx + 1];
                    headerCols.slice(1).forEach(col => {
                        let val = entry[col] !== undefined ? entry[col] : '';
                        row.push(val);
                    });
                    csv += row.map(cell => {
                        if (typeof cell === 'string') return `"${cell.replace(/"/g, '""')}"`;
                        else return cell;
                    }).join(',') + '\n';
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'data.csv';
                a.click();
                URL.revokeObjectURL(url);
            }

            downloadBtn.addEventListener('click', () => {
                downloadDataAsCSV(logEntries, 'current_session.csv');
            });

            // Save to Drive demo
            saveToDriveBtn.addEventListener('click', () => {
                if (!currentUser) return;
                const user = users.find(u => u.username === currentUser);
                if (!user) return;
                const allLogs = loadUserLogs(currentUser);
                const allEntries = allLogs.flatMap(l => l.entries);
                if (allEntries.length === 0) {
                    alert('No data to save.');
                    return;
                }
                downloadDataAsCSV(allEntries, `${currentUser}_all_data.csv`);
                alert(`Demo: File downloaded. To save to your registered drive (${user.email || 'no email'}), manually upload this file to:\nhttps://drive.google.com/drive/folders/1V1fS8vriE3QqVuHu8TPZbABeBo14RPTP`);
            });

            addParamBtn.addEventListener('click', addParameter);
            voiceToggleBtn.addEventListener('click', toggleListening);

            paramNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addParameter(); });
            paramUnitInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addParameter(); });

            window.addEventListener('beforeunload', () => {
                if (isListening && recognition) {
                    try { recognition.stop(); } catch (e) {}
                }
            });

            renderParameters();
            renderLogTable();

            // Auto-login if session exists
            const savedUser = sessionStorage.getItem('currentUser');
            const savedIsAdmin = sessionStorage.getItem('isAdmin') === 'true';
            if (savedUser) {
                currentUser = savedUser;
                isAdmin = savedIsAdmin;
                loginOverlay.style.display = 'none';
                mainApp.style.display = 'block';
                userDisplay.innerText = `Logged in as: ${currentUser}${isAdmin ? ' (Admin)' : ''}`;
                if (!isAdmin) {
                    logs = loadUserLogs(currentUser);
                    if (!logs || logs.length === 0) {
                        logs = [createLog('Default')];
                        saveUserLogs(currentUser, logs);
                    }
                    currentLogId = logs[0].id;
                    parameters = logs[0].parameters || [];
                    logEntries = logs[0].entries || [];
                    renderParameters();
                    renderLogTable();
                    updateLogSelect();
                } else {
                    adminPanel.style.display = 'block';
                    populateUserSelect();
                }
            }
        })();
    </script>
</body>
</html>